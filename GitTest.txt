package sl.lyt.main.beam;

import org.apache.beam.runners.flink.FlinkRunner;
import org.apache.beam.sdk.Pipeline;
import org.apache.beam.sdk.coders.SerializableCoder;
import org.apache.beam.sdk.options.PipelineOptions;
import org.apache.beam.sdk.options.PipelineOptionsFactory;
import org.apache.beam.sdk.transforms.Create;
import org.apache.beam.sdk.transforms.DoFn;
import org.apache.beam.sdk.transforms.Flatten;
import org.apache.beam.sdk.transforms.ParDo;
import org.apache.beam.sdk.values.PCollection;
import org.apache.beam.sdk.values.PCollectionList;
import sl.lyt.main.beam.bean.DataCdrMainRows;
import sl.lyt.main.beam.bean.MainRowsBase;
import sl.lyt.main.beam.bean.PacketCdrMainRows;
import sl.lyt.main.beam.bean.VoiceCdrMainRows;

public class RowPipelineTest {
    public static void main(String[] args) {
        PipelineOptions pipelineOptions = PipelineOptionsFactory.create();
        pipelineOptions.setRunner(FlinkRunner.class);
        Pipeline pipeline = Pipeline.create();

        // pipeline.getCoderRegistry().registerCoderForClass(MainRowsBase.class, SerializableCoder.of(MainRowsBase.class));

        PCollection<MainRowsBase> pc1 = pipeline
                .apply(Create.<MainRowsBase>of(
                        new DataCdrMainRows("b1", "s1", "m1", "cdrKey1", "o1", "222", "333")
                ).withCoder(SerializableCoder.of(MainRowsBase.class)));

        PCollection<MainRowsBase> pc2 = pipeline
                .apply(Create.<MainRowsBase>of(
                        new VoiceCdrMainRows("b1", "s1", "m1", "cdrKey1", "o1", "444", "555")
                ).withCoder(SerializableCoder.of(MainRowsBase.class)));

        PCollection<MainRowsBase> pc3 = pipeline
                .apply(Create.<MainRowsBase>of(
                        new PacketCdrMainRows("b1", "s1", "m1", "cdrKey1", "o1", "666", "777")
                ).withCoder(SerializableCoder.of(MainRowsBase.class)));

        PCollection<MainRowsBase> merged = PCollectionList.of(pc1).and(pc2).and(pc3).apply(Flatten.pCollections());

        merged.apply(ParDo.of(new DoFn<MainRowsBase, Void>() {
            @ProcessElement
            public void process(ProcessContext context) {
                MainRowsBase element = context.element();
                System.out.println(element.toString());
            }
        }));

        pipeline.run().waitUntilFinish();

    }
}
